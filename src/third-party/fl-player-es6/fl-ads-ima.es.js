/*! ******************************************************************************* 
   Package Name: fl-ads-ima
   Generated: 2022-08-24
   Version: 7.0.56

   Copyright (C) Firstlight Media. All rights reserved.  
   
   All information contained herein is, and remains the property of Firstlight Media. 
   The intellectual and technical concepts contained herein are proprietary to 
   Firstlight Media.  

   Dissemination of this information or reproduction of this material is strictly 
   forbidden unless prior written permission is obtained from Firstlight Media.  
   ******************************************************************************* */
import{AdContentTimePosition as e,PLAYBACK_STATES as t,SEEKING_STATES as r,BUFFERING_STATES as n,AdTrackingEvent as a,AdEvent as i,PlayerContext as s}from"./fl-player-interface.es";import{createEventEmitter as d,createLogger as o,LoggerLevel as u}from"./fl-foundation.es";function l(t){if(t)switch(t){case 0:return e.PREROLL;case-1:return e.POSTROLL;default:return e.MIDROLL}return e.UNKNOWN}function E(e){return{adSystem:e.adSystem,adTitle:e.title,description:e.description,advertiser:e.advertiserName,survey:e.surveyUrl,creativeId:e.creativeId}}function c(e){const s=e.configuredLogger,o=d(),u=e.renderingSettings,c=e.videoElement,p=e.containerElement,A=e.imaSDK,g=e.request;let T,y,b="",m=null,D="idle",I=0,v=0,k=!1;const L=[];let f,O,S=!1;const R=()=>{switch(D){case"loading":return t.LOADING;case"loaded":return t.LOADED;case"playing":case"skipped":case"started":case"resumed":case"completed":return t.STARTED;case"paused":return t.PAUSED;default:return t.IDLE}},_=(e,a)=>{D=e,"buffering"===D?(()=>{const e=R(),t=k?n.ACTIVE:n.INACTIVE,a={buffering:t,seeking:r.INACTIVE,player:e};s.info("Player state has changed",JSON.stringify(a)),o.publish("bufferingstatechanged",t)})():"failed"===D?s.log("aderror",a):(()=>{const e=R();if(e===t.LOADED||e===t.LOADING)return;const a={player:e,seeking:r.INACTIVE,buffering:n.INACTIVE};s.info("Player state has changed",JSON.stringify(a)),o.publish("playbackstatechanged",e)})()},P={subscribe:o.subscribe,unsubscribe:o.unsubscribe,get playerState(){return R()},get isBuffering(){return k},get isSeeking(){return!1},get currentTime(){return I},get currentEpochTime(){return 0},get duration(){return v},get playbackRate(){return 0},get availableBitrates(){return L},get minBitrate(){return 0},get maxBitrate(){return 0},get internalPlayerVersion(){return b},get internalPlayerName(){return"IMA SDK"},get isLive(){return!1},get remainingTime(){return m&&m.getRemainingTime()},get isMute(){return!(m&&m.getVolume())},load(){_("loading"),function(e){T.initialize();const t=new A.AdsRequest;s.debug(`Requesting ${e.adTagUrl} with w:${e.slotWidth}, h:${e.slotHeight}`),t.adTagUrl=e.adTagUrl,t.linearAdSlotWidth=e.slotWidth,t.linearAdSlotHeight=e.slotHeight,y.requestAds(t)}(g)},play(){m&&m.resume()},pause(){m&&m.pause()},abort:e=>{m&&m.destroy()},send(e,t,r){s.log(`streamTimelineEvent: ${e} Action: ${t} metadata: ${r}`)},seek(e){},getThumbnail(e){},getAllTracks:()=>[],getActiveTracks:()=>[],seekableRange:()=>({start:0,end:v}),seekToLiveEdge(){},currentOffsetFromLiveEdge:()=>0,selectTrack(e){},stop:()=>(m&&m.destroy(),_("idle"),Promise.resolve()),muteOrUnmute(){m&&(this.isMute?m.setVolume(c.volume):m.setVolume(0))},skipAd(){_("skipped"),m&&m.skip()},resize(e,t,r){r?m&&m.resize(e,t,A.ViewMode.FULLSCREEN):m&&m.resize(e,t,A.ViewMode.NORMAL)},discardAdBreak(){m&&m.discardAdBreak()},getCuePoints:()=>m&&m.getCuePoints(),setRequestInterceptor(e){},setResponseInterceptor(e){},accessFunctionHandler(e){},setPlaybackOptions(e){s.log("playback options",e)}};function N(e){s.debug("onAdsManagerLoaded",e);let t=new A.AdsRenderingSettings;t.restoreCustomPlaybackStateOnAdBreakComplete=!0,u&&(t=function(e,t){e.autoAlign=!!t.autoAlign,e.bitrate=t.bitrate?t.bitrate:-1,e.enablePreloading=!!t.enablePreloading,e.loadVideoTimeout=t.loadVideoTimeout?t.loadVideoTimeout:-1,e.mimeTypes=t.mimeTypes?t.mimeTypes:[],e.UiElements=t.enableUiElements?[A.UiElements.AD_ATTRIBUTION,A.UiElements.COUNTDOWN]:[],e.useStyledLinearAds=!!t.useStyledLinearAds,e.useStyledNonLinearAds=!!t.useStyledNonLinearAds,t.playAdsAfterTime&&(e.playAdsAfterTime=t.playAdsAfterTime);return e}(t,u)),m=e.getAdsManager(c,t),m&&m.getCuePoints()&&o.publish("adcuepoints",m.getCuePoints()),function(e){e.addEventListener(A.AdEvent.Type.CONTENT_PAUSE_REQUESTED,B),e.addEventListener(A.AdEvent.Type.CONTENT_RESUME_REQUESTED,K),e.addEventListener(A.AdErrorEvent.Type.AD_ERROR,V,!1),e.addEventListener(A.AdError.Type.AD_LOAD,(e=>{s.log("adLoadError",e)})),e.addEventListener(A.AdError.Type.AD_PLAY,(e=>{s.log("adPlayError",e)}));const t=[A.AdEvent.Type.ALL_ADS_COMPLETED,A.AdEvent.Type.CLICK,A.AdEvent.Type.COMPLETE,A.AdEvent.Type.FIRST_QUARTILE,A.AdEvent.Type.LOADED,A.AdEvent.Type.MIDPOINT,A.AdEvent.Type.PAUSED,A.AdEvent.Type.STARTED,A.AdEvent.Type.RESUMED,A.AdEvent.Type.AD_PROGRESS,A.AdEvent.Type.THIRD_QUARTILE,A.AdEvent.Type.SKIPPED,A.AdEvent.Type.SKIPPABLE_STATE_CHANGED,A.AdEvent.Type.LOG,A.AdEvent.Type.CLICK,A.AdEvent.Type.VIDEO_CLICKED,A.AdEvent.Type.VIDEO_ICON_CLICKED,A.AdEvent.Type.IMPRESSION,A.AdEvent.Type.USER_CLOSE,A.AdEvent.Type.INTERACTION,A.AdEvent.Type.VOLUME_CHANGED,A.AdEvent.Type.VOLUME_MUTED];for(const r in t)e.addEventListener(t[r],M,!1);e.init(g.slotWidth,g.slotHeight,A.ViewMode.NORMAL),e.start()}(m)}const h=(e,t)=>function(e,t){const r=(e?e.getAdData():void 0).adPodInfo;return{adBreakID:" ",contentTimePosition:l(r.podIndex),adSequencePosition:1,adBreakStartTimeOffsetMs:1e3*r.timeOffset,remainingTimeMs:1e3*t.getRemainingTime(),durationMs:1e3*r.maxDuration,totalAds:r.totalAds,adBreakIndex:r.podIndex}}(e,t),C=(e,t,r)=>function(e,t,r){const n=e?e.getAdData():void 0,a=n.adPodInfo;return{adID:n.adId||" ",sequence:a.adPosition,adStartTimeOffsetMs:1e3*a.timeOffset,durationMs:1e3*n.duration,remainingTimeMs:1e3*t.getRemainingTime(),isSkippable:n.skippable,skipOffsetMs:1e3*n.skipTimeOffset,isFiller:!1,adBreakInfo:r||void 0,vastProperties:n?E(n):void 0}}(e,t,r);function M(e){switch(e.type){case A.AdEvent.Type.LOADED:f=h(e,m),O=C(e,m,f),v=O.durationMs?O.durationMs:0,_("loaded");break;case A.AdEvent.Type.STARTED:k=!1,_("started"),(t=e.getAd())&&O&&(O.mediaUrl=t.getMediaUrl()||"",O.vastProperties&&(O.vastProperties.bitrate=t.getVastMediaBitrate()||0)),o.publish(i.ADVERT_START,O);break;case A.AdEvent.Type.RESUMED:k&&(k=!1,_("buffering")),_("resumed"),o.publish(i.ADVERT_START,O),U(a.AD_RESUMED_EVENT);break;case A.AdEvent.Type.AD_BUFFERING:k=!0,_("buffering");break;case A.AdEvent.Type.FIRST_QUARTILE:f&&e.getAd()&&(f.totalAds=e.getAd().getAdPodInfo().getTotalAds()),U(a.AD_FIRST_QUARTILE_EVENT);break;case A.AdEvent.Type.MIDPOINT:U(a.AD_MIDPOINT_EVENT);break;case A.AdEvent.Type.THIRD_QUARTILE:U(a.AD_THIRD_QUARTILE_EVENT);break;case A.AdEvent.Type.AD_PROGRESS:const r=e.getAdData();if(!r)return;const n=1e3*r.currentTime;I=n,_("playing");const d=1e3*m.getRemainingTime();f&&(f.remainingTimeMs=d),O&&(O.adBreakInfo=f,O.remainingTimeMs=d),o.publish("adprogressupdate",O,n);break;case A.AdEvent.Type.PAUSED:_("paused");break;case A.AdEvent.Type.SKIPPED:_("skipped"),o.publish(i.ADVERT_END,O),U(a.AD_SKIPPED_EVENT),O=void 0;break;case A.AdEvent.Type.COMPLETE:_("completed"),o.publish(i.ADVERT_END,O),O=void 0;break;case A.AdEvent.Type.ALL_ADS_COMPLETED:break;case A.AdEvent.Type.LOG:!function(e){e.getAdData()&&e.getAdData().adError&&s.log("aderror",e.getAdData().adError)}(e);break;case A.AdEvent.Type.CLICK:U(a.AD_CLICK);break;case A.AdEvent.Type.VIDEO_CLICKED:U(a.AD_VIDEO_CLICKED);break;case A.AdEvent.Type.VIDEO_ICON_CLICKED:U(a.AD_VIDEO_ICON_CLICKED);break;case A.AdEvent.Type.IMPRESSION:U(a.AD_IMPRESSION);break;case A.AdEvent.Type.USER_CLOSE:U(a.AD_USER_CLOSE);break;case A.AdEvent.Type.INTERACTION:U(a.AD_INTERACTION);break;case A.AdEvent.Type.VOLUME_CHANGED:U(a.AD_VOLUME_CHANGED);break;case A.AdEvent.Type.VOLUME_MUTED:U(a.AD_VOLUME_MUTED);break;case A.AdEvent.Type.SKIPPABLE_STATE_CHANGED:U(a.AD_SKIPPABLE_STATE_CHANGED)}var t}function U(e){s.log(`IMA: ad event "${e}"`),o.publish(i.ADVERT_TRACKING_EVENT,e)}function V(e){_("failed",e.getError()),o.publish("aderror",e.getError()),o.publish("adstatechanged",!1)}function B(){S=!0,o.publish(i.ADVERT_BREAK_START,f),o.publish("adstatechanged",!0),o.publish("adplayercontextwillchange")}function K(){S&&(o.publish(i.ADVERT_BREAK_END,f),f=void 0,S=!1),o.publish("adstatechanged",!1),o.publish("adplayercontextwillchange")}return s.debug("Initializing IMA SDK"),T=new A.AdDisplayContainer(p,c),y=new A.AdsLoader(T),y.addEventListener(A.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,N,!1),y.addEventListener(A.AdErrorEvent.Type.AD_ERROR,V,!1),b=y.getVersion(),c.onended=function(){y.contentComplete()},P}function p(e){const a=e.configuredLogger,i=d(),o=e.player,u=e=>{o.playbackOptions&&o.setPlaybackOptions({...o.playbackOptions,autoPlayOnLoad:e})};let l=!!o.playbackOptions&&o.playbackOptions.autoPlayOnLoad;u(!1);const E=c(e);let p=s.MAIN,A=!1,g=!1;const T=()=>{E.load(),o.load()},y=()=>p===s.AD,b=e=>{p=e,a.info(`Switched to context: ${p}`),i.publish("playercontextchanged",p)},m=e=>{e?(b(s.AD),o.pause()):(b(s.MAIN),l&&(o.playerState===t.LOADING?u(!0):(o.playerState!==t.LOADED||A)&&A||o.play()),(!g&&!l||A)&&(()=>{if(o.playerState===t.LOADING)return;const e={player:o.playerState,seeking:r.INACTIVE,buffering:n.INACTIVE};a.info("Player state has changed",JSON.stringify(e)),i.publish("playbackstatechanged",o.playerState)})())},D={subscribe(e,t){E.subscribe(e,t),o.subscribe(e,t),i.subscribe(e,t)},unsubscribe(e,t){E.unsubscribe(e,t),o.unsubscribe(e,t),i.unsubscribe(e,t)},get playerContext(){return!y()&&"playerContext"in o?o.playerContext:p},get playerState(){return y()?E.playerState:o.playerState},get playbackRate(){return o.playbackRate},set playbackRate(e){y()||(o.playbackRate=e)},get availableBitrates(){return y()?E.availableBitrates:o.availableBitrates},set minBitrate(e){y()||(o.minBitrate=e)},get minBitrate(){return y()?E.minBitrate:o.minBitrate},set maxBitrate(e){y()||(o.maxBitrate=e)},get maxBitrate(){return y()?E.maxBitrate:o.maxBitrate},get internalPlayerName(){return y()?E.internalPlayerName:o.internalPlayerName},get internalPlayerVersion(){return y()?E.internalPlayerVersion:o.internalPlayerVersion},get rawPlayer(){return y()?void 0:o.rawPlayer},get rawLibrary(){return y()?void 0:o.rawLibrary},get isBuffering(){return y()?E.isBuffering:o.isBuffering},get isSeeking(){return y()?E.isSeeking:o.isSeeking},get currentTime(){return y()?E.currentTime:o.currentTime},get currentEpochTime(){return y()?E.currentEpochTime:o.currentEpochTime},get duration(){return y()?E.duration:o.duration},get playbackStatistics(){return y()?E.playbackStatistics:o.playbackStatistics},get isLive(){return o.isLive},get remainingTime(){return y()?E.remainingTime:-1},get isMute(){return y()?E.isMute:o.isMute},get playbackOptions(){return o.playbackOptions?o.playbackOptions:void 0},load(){T()},setRequestInterceptor(e){o.setRequestInterceptor(e)},setResponseInterceptor(e){o.setResponseInterceptor(e)},accessFunctionHandler(e){o.accessFunctionHandler(e)},stop:()=>y()?E.stop().finally((()=>o.stop())):o.stop(),play(){l=!0,"idle"!==E.playerState||"idle"!==o.playerState?y()?E.play():o.play():T()},pause(){y()?E.pause():o.pause()},abort:e=>{E.abort(e),o.abort(e)},send(e,t,r){E.send(e,t,r),o.send(e,t,r)},seek(e){y()?E.seek(e):o.seek(e)},getThumbnail:e=>y()?E.getThumbnail(e):o.getThumbnail(e),seekToLiveEdge:()=>y()?E.seekToLiveEdge():o.seekToLiveEdge(),seekableRange:()=>y()?E.seekableRange():o.seekableRange(),currentOffsetFromLiveEdge:()=>y()?E.currentOffsetFromLiveEdge():o.currentOffsetFromLiveEdge(),getAllTracks:()=>y()?[]:o.getAllTracks(),getActiveTracks:()=>y()?[]:o.getActiveTracks(),selectTrack(e){y()||o.selectTrack(e)},muteOrUnmute(){E.muteOrUnmute&&E.muteOrUnmute(),o.muteOrUnmute&&o.muteOrUnmute()},skipAd(){y()?E.skipAd():a.warn(`Unsupported operation 'skipAd' in ${p} context`)},resize(e,t,r){E.resize(e,t,r)},discardAdBreak(){y()?E.discardAdBreak():a.warn(`Unsupported operation 'discardAdBreak' in ${p} context`)},getCuePoints:()=>E.getCuePoints(),setPlaybackOptions(e){o.setPlaybackOptions(e)}};return E.subscribe("adstatechanged",(e=>{m(e)})),(e=>{e.subscribe("playbackstatechanged",(e=>{e===t.STARTED&&(g=!0,A=!1),a.debug(`Content Player state: ${e}`)})),e.subscribe("streamended",(()=>{A=!0}))})(o),D}function A(){let e,t,r,n,a,i,s=o(u.OFF);return{get player(){return e},get containerElement(){return t},get videoElement(){return r},get imaSDK(){return n},get configuredLogger(){return s},get request(){return a},get renderingSettings(){return i},contentPlayer(t){return e=t,this},contentContainerElement(e){return t=e,this},contentVideoElement(e){return r=e,this},adRequest(e){return a=e,this},ima(e){return n=e,this},adsRenderingSettings(e){return i=e,this},logger(e){return s=e,this},build(){return p(this)}}}const g="7.0.56";export{A as createPlayerBuilder,g as version};

