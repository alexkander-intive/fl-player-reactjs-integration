/*! ******************************************************************************* 
   Package Name: fl-heartbeat
   Generated: 2022-08-24
   Version: 7.0.56

   Copyright (C) Firstlight Media. All rights reserved.  
   
   All information contained herein is, and remains the property of Firstlight Media. 
   The intellectual and technical concepts contained herein are proprietary to 
   Firstlight Media.  

   Dissemination of this information or reproduction of this material is strictly 
   forbidden unless prior written permission is obtained from Firstlight Media.  
   ******************************************************************************* */
import{createRequestBuilder as e,AsyncUtil as t,createEventEmitter as r,createError as n,ErrorCodes as i,PlatformUtil as o,createLogger as a,LoggerLevel as c}from"fl-foundation";import{PLAYBACK_STATES as u,StreamTimelineEvent as s,Action as E,BlackoutAction as l}from"fl-player-interface";import{AuthorizationUtil as v}from"fl-platform-authorizer";function d(r,n,i){const o=i&&i.maxRetries;return{putStreamForDeviceId:i=>async function(i){try{const a={deviceId:i},c=e().url(r).path("/user/stream/create").put(a).headers({accept:"application/json"}).build();return t.retryOnNetworkFailure((()=>v.makeAuthorizedRequest(c,n)),o),Promise.resolve()}catch(e){return Promise.reject(e)}}(i),deleteStreamForDeviceId:i=>async function(i){try{const a={deviceId:i},c=e().url(r).path(`/user/stream/delete/${i}`).delete(a).headers({accept:"application/json"}).build();return t.retryOnNetworkFailure((()=>v.makeAuthorizedRequest(c,n)),o),Promise.resolve()}catch(e){return Promise.reject(e)}}(i)}}function f(t,r,n,i,o){const a={headers:o,heartbeat:(o,c)=>async function(o,c){try{const u={deviceId:r,itemId:t,...c&&{offset:c}},s=e().url(n).path("/user/heartbeat/update").post(u).headers({accept:"application/json",...a.headers,"X-Heartbeat":o}).build(),E=await v.makeAuthorizedRequest(s,i);return Promise.resolve(E.data)}catch(e){return Promise.reject(e)}}(o,c)};return a}const T=Object.freeze({BLACKOUT_DENY_FAILURE:1025,BLACKOUT_ALLOW_UPGRADE_FAILURE:1026});var m;function h(e){let t,a=0,c=!1,v=!1,h=!1;const S=e.logger,A=r(),p=e.configuration,b=p.syncIntervalMS||6e4,R=p.maxAllowedFailures||2,_=p.stopPlayerOnStreamTimelineEvent,O=p.showPostEventSlateTimeMs||9e5;let g=e.streamConcurrencyService,L=e.heartbeatService,y=e.heartbeatToken,I=e.liveStartTime,P=e.liveEndTime,C=G(I),N=G(P);const k=function(e){if(!e)return 0;const t=new Date(e);return new Date(t.getTime()+O).valueOf()/1e3}(P);let D=e.overflowEventMode,U=p.multiStreamMode;const F=e.liveEventType;let w;const V={subscribe(e,t){A.subscribe(e,t)},unsubscribe(e,t){A.unsubscribe(e,t)},get streamConcurrencyService(){return g||(g=d(p.streamConcurrencyEndPointUrl,e.platformAuthorizer,e.configuration)),g},get heartbeatService(){return L||(L=f(e.contentId,e.deviceId,p.heartbeatEndPointUrl,e.platformAuthorizer,e.headers)),L},processPlayerStateChange(r){switch(r.playerState){case u.STARTED:c&&(!0!==U&&function(t){const r=()=>{V.streamConcurrencyService.putStreamForDeviceId(e.deviceId).catch((e=>{t.abort(e),H()}))};if(!w)return void r();w.finally((()=>{r()}))}(r),c=!1),function(e){if(t)return;t=setInterval((async()=>{await async function(e){if(!y)return;try{const t=function(e){return!e.isLive&&!0===p.recordBookmark}(e)?e.currentTime:void 0,r=await V.heartbeatService.heartbeat(y,t);if(!r)return;switch(r.heartbeatToken&&(y=r.heartbeatToken),r.liveEndTime&&(P=r.liveEndTime,N=G(P)),r.liveStartTime&&(I=r.liveStartTime,C=G(I)),r.blackoutAction){case l.DENY:case l.ALLOW_WITH_UPGRADE:const t={blackoutUrl:r.blackoutUrl,blackoutAction:r.blackoutAction};A.publish("blackout",t),e.send(s.BLACKOUT,E.NONE,t),e.abort(function(e){const t=e===l.ALLOW_WITH_UPGRADE?T.BLACKOUT_ALLOW_UPGRADE_FAILURE:T.BLACKOUT_DENY_FAILURE;return n(t|i.ERROR_CATEGORY_MASK_SERVER,"Blacked-out")}(r.blackoutAction)),H()}a=0}catch(t){!function(e){const t=e&&e.doesBelongToCategory(i.ERROR_CATEGORY_MASK_NETWORK);return o.isPS4()&&t}(t)?a++:S.warn("Ignoring Heartbeat ping time-out on PlayStation 4 platform");(t&&t.doesBelongToCategory(i.ERROR_CATEGORY_MASK_SERVER)||a>=R)&&(e.abort(t),H())}}(e)}),b)}(r);break;case u.PAUSED:case u.STOPPED:case u.IDLE:c=!0,!0!==U&&(w=V.streamConcurrencyService.deleteStreamForDeviceId(e.deviceId).catch((e=>{}))),H()}},processHeartbeatChange(e){if(e.isLive)if(function(){if(!F)return!1;return D===m.PRE_EVENT}()&&function(e){if(!C||e.currentEpochTime<=0)return!1;return e.currentEpochTime+e.currentOffsetFromLiveEdge()>=C}(e)&&!v)v=!0,e.send(s.LIVE_EVENT_START,E.START_PLAYBACK),B(e);else if(M()||!function(e){if(!N||e.currentEpochTime<=0)return!1;return e.currentEpochTime>=N}(e)||h)M()&&function(e){if(!k||e.currentEpochTime<=0)return!1;return e.currentEpochTime>=k}(e)&&(e.send(s.OVERFLOW_EVENT_END,E.NONE),B(e));else{h=!0;const t=function(){if(!F)return!1;return D===m.EVENT||void 0===D}()?s.LIVE_EVENT_END:s.LIVE_PROGRAM_END;e.send(t,E.NONE),B(e)}},setOverflowEventMode(e){D=e},setMultiStreamMode(e){U=e}};function M(){return!!F&&D===m.POST_EVENT}function B(e){!1!==_&&e.stop()}function H(){clearInterval(t),t=void 0}function G(e){return e?new Date(e).valueOf()/1e3:0}return V}!function(e){e.PRE_EVENT="preEvent",e.EVENT="event",e.POST_EVENT="postEvent"}(m||(m={}));function S(e,t,r,n){const i=e,o=t,u=r,s=n;let E,l,v,d,f,T,m,S,A=a(c.OFF,"FL_HEARTBEAT");return{get deviceId(){return i},get contentId(){return o},get heartbeatToken(){return E},get configuration(){return u},get streamConcurrencyService(){return v},get heartbeatService(){return d},get platformAuthorizer(){return s},get headers(){return l},get logger(){return A},get liveStartTime(){return f},get liveEndTime(){return T},get liveEventType(){return m},get overflowEventMode(){return S},setHeartbeatToken(e){return E=e,this},setHeaders(e){return l=e,this},setStreamConcurrencyService(e){return v=e,this},setHeartbeatService(e){return d=e,this},setLogger(e){return A=e,this},setLiveStartTime(e){return f=e,this},setLiveEndTime(e){return T=e,this},setLiveEventType(e){return m=e,this},setOverflowEventMode(e){return S=e,this},build(){return h(this)}}}var A,p;!function(e){e.GRACEFUL_STOP="GRACEFUL_STOP"}(A||(A={})),function(e){e.LIVE="live",e.RESTART="restart",e.CATCHUP="catchup"}(p||(p={}));const b="7.0.56";export{A as HeartbeatAction,T as HeartbeatErrorCodes,m as OverflowEventMode,p as PlaybackMode,S as createHeartbeatBuilder,f as createHeartbeatService,d as createStreamConcurrencyService,b as version};

