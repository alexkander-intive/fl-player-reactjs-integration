/*! ******************************************************************************* 
   Package Name: fl-conviva
   Generated: 2022-08-24
   Version: 7.0.56

   Copyright (C) Firstlight Media. All rights reserved.  
   
   All information contained herein is, and remains the property of Firstlight Media. 
   The intellectual and technical concepts contained herein are proprietary to 
   Firstlight Media.  

   Dissemination of this information or reproduction of this material is strictly 
   forbidden unless prior written permission is obtained from Firstlight Media.  
   ******************************************************************************* */
import{BUFFERING_STATES as t,PLAYBACK_STATES as a,SEEKING_STATES as e,PlayerContext as i,AdContentTimePosition as s}from"./fl-player-interface.es";import{ErrorCodes as n,createLogger as r,LoggerLevel as o}from"./fl-foundation.es";var d;!function(t){t.CLIENT_SIDE="CLIENT_SIDE",t.SERVER_SIDE="SERVER_SIDE"}(d||(d={}));class l{constructor(l,h,v,c){this.initializationData=l,this.bufferingState=t.INACTIVE,this.subscribeToInternalPlayerEvents=t=>{t?(t.subscribe("bufferingstatechanged",this.onBufferingStateChanged),t.subscribe("progressupdate",this.onProgressUpdate),t.subscribe("streamended",this.onStreamEnded),t.subscribe("seekingstatechanged",this.onSeekingStateChanged),t.subscribe("playbackstatechanged",this.onPlaybackStateChanged),t.subscribe("bandwidthchanged",this.onBandwidthChanged),t.subscribe("adbreakstart",this.onAdBreakStart),t.subscribe("adbreakend",this.onAdBreakEnd),t.subscribe("adstart",this.onAdStart),t.subscribe("adend",this.onAdEnd),t.subscribe("adprogressupdate",this.onAdProgressUpdate),t.subscribe("error",this.onError),t.subscribe("aderror",this.onAdError)):this.logger.log("[Conviva][Error] Cannot subscribe to undefined player events")},this.unsubscribeFromInternalPlayerEvents=t=>{t?(t.unsubscribe("bufferingstatechanged",this.onBufferingStateChanged),t.unsubscribe("progressupdate",this.onProgressUpdate),t.unsubscribe("streamended",this.onStreamEnded),t.unsubscribe("seekingstatechanged",this.onSeekingStateChanged),t.unsubscribe("playbackstatechanged",this.onPlaybackStateChanged),t.unsubscribe("bandwidthchanged",this.onBandwidthChanged),t.unsubscribe("adbreakstart",this.onAdBreakStart),t.unsubscribe("adbreakend",this.onAdBreakEnd),t.unsubscribe("adstart",this.onAdStart),t.unsubscribe("adend",this.onAdEnd),t.unsubscribe("adprogressupdate",this.onAdProgressUpdate),t.unsubscribe("error",this.onError),t.unsubscribe("aderror",this.onAdError)):this.logger.log("[Conviva][Error] Cannot unsubscribe from undefined player events")},this.onBufferingStateChanged=e=>{if(this.videoAnalytics)switch(this.logger.log("[Conviva][PlayerEvent] bufferingstatechanged",e),e){case t.ACTIVE:this.bufferingState=t.ACTIVE,this.reportPlaybackMetric(Conviva.Constants.Playback.PLAYER_STATE,Conviva.Constants.PlayerState.BUFFERING);break;case t.INACTIVE:this.bufferingState=t.INACTIVE,this.internalPlayer&&this.internalPlayer.playerState===a.PAUSED?this.reportPlaybackMetric(Conviva.Constants.Playback.PLAYER_STATE,Conviva.Constants.PlayerState.PAUSED):this.reportPlaybackMetric(Conviva.Constants.Playback.PLAYER_STATE,Conviva.Constants.PlayerState.PLAYING)}},this.onProgressUpdate=()=>{if(!this.internalPlayer||!this.internalPlayer.duration)return;const t={};this.internalPlayer.isLive||(t["Conviva.duration"]=this.internalPlayer.duration),this.videoAnalytics&&Object.keys(t).length&&this.videoAnalytics.setContentInfo(t)},this.onStreamEnded=()=>{this.videoAnalytics&&(this.logger.log("[Conviva][PlayerEvent] streamended"),this.videoAnalytics.reportPlaybackEnded())},this.onSeekingStateChanged=t=>{if(this.videoAnalytics)switch(this.logger.log("[Conviva][PlayerEvent] seekingstatechanged",t),t){case e.ACTIVE:this.reportPlaybackMetric(Conviva.Constants.Playback.SEEK_STARTED);break;case e.INACTIVE:this.reportPlaybackMetric(Conviva.Constants.Playback.SEEK_ENDED)}},this.onPlaybackStateChanged=e=>{if(this.videoAnalytics)switch(this.logger.log("[Conviva][PlayerEvent] playbackstatechanged",e),e){case a.LOADING:case a.LOADED:break;case a.STARTED:if(!this.isMainContext(this.internalPlayer))return;this.setContentMetadata({[Conviva.Constants.IS_LIVE]:this.isLive(this.internalPlayer)}),this.bufferingState!==t.ACTIVE&&this.reportPlaybackMetric(Conviva.Constants.Playback.PLAYER_STATE,Conviva.Constants.PlayerState.PLAYING),this.internalPlayer&&this.internalPlayer.playbackStatistics&&(this.reportPlaybackMetric(Conviva.Constants.Playback.BITRATE,this.internalPlayer.playbackStatistics.variantBitrate/1e3),this.internalPlayer.playbackStatistics.framerate&&this.reportPlaybackMetric(Conviva.Constants.Playback.RENDERED_FRAMERATE,this.internalPlayer.playbackStatistics.framerate));break;case a.PAUSED:if(!this.isMainContext(this.internalPlayer))return;this.reportPlaybackMetric(Conviva.Constants.Playback.PLAYER_STATE,Conviva.Constants.PlayerState.PAUSED);break;case a.STOPPED:this.reportPlaybackMetric(Conviva.Constants.Playback.PLAYER_STATE,Conviva.Constants.PlayerState.STOPPED);break;case a.IDLE:this.videoAnalytics.reportPlaybackEnded(),this.unsubscribeFromInternalPlayerEvents(this.internalPlayer),this.internalPlayer=void 0}},this.onBandwidthChanged=()=>{this.videoAnalytics&&(this.internalPlayer&&this.internalPlayer.playbackStatistics?(this.logger.log("[Conviva][PlayerEvent] bandwidthchanged",this.internalPlayer.playbackStatistics.variantBitrate/1e3),this.reportPlaybackMetric(Conviva.Constants.Playback.BITRATE,this.internalPlayer.playbackStatistics.variantBitrate/1e3)):this.logger.log("[Conviva][PlayerEvent] bandwidthchanged - Bitrate is not available"))},this.onAdBreakStart=t=>{this.videoAnalytics&&!this.isAdBreakStartReported&&(this.isAdBreakStartReported=!0,this.isAdBreakEndReported=!1,this.logger.log("[Conviva][PlayerEvent] adbreakstart",t),this.adMetadata&&this.adMetadata.adTechnology===d.SERVER_SIDE?this.videoAnalytics.reportAdBreakStarted(Conviva.Constants.AdType.SERVER_SIDE,Conviva.Constants.AdPlayer.CONTENT):this.videoAnalytics.reportAdBreakStarted(Conviva.Constants.AdType.CLIENT_SIDE,Conviva.Constants.AdPlayer.SEPARATE))},this.onAdBreakEnd=t=>{this.videoAnalytics&&!this.isAdBreakEndReported&&(this.isAdBreakEndReported=!0,this.isAdBreakStartReported=!1,this.logger.log("[Conviva][PlayerEvent] adbreakend",t),this.videoAnalytics.reportAdBreakEnded())},this.onAdStart=t=>{this.adAnalytics&&(this.logger.log("[Conviva][PlayerEvent] adstart",t),this.adAnalytics.reportAdStarted(this.buildAdMetadata(t)),t.vastProperties&&t.vastProperties.bitrate&&this.adAnalytics.reportAdMetric(Conviva.Constants.Playback.BITRATE,t.vastProperties.bitrate))},this.onAdEnd=t=>{this.adAnalytics&&(this.logger.log("[Conviva][PlayerEvent] adend",t),this.adAnalytics.reportAdEnded())},this.onAdProgressUpdate=(t,a)=>{this.adAnalytics&&(this.logger.log("[Conviva][PlayerEvent] adprogressupdate",t,a),this.adAnalytics.reportAdMetric(Conviva.Constants.Playback.PLAYER_STATE,Conviva.Constants.PlayerState.PLAYING))},this.onError=t=>{if(!t||!this.videoAnalytics)return;this.logger.log("[Conviva][PlayerEvent] error",t);let a=`${t}`;t.doesBelongToCategory&&t.doesBelongToCategory(n.ERROR_CATEGORY_MASK_SERVER)&&t.internalError?a=`${t.internalError.errorMessage} (${t.internalError.errorCode})`:t.hexErrorCode?a=`${t.errorMessage} (${t.hexErrorCode})`:void 0!==t.errorCode&&(a=`${t.errorMessage} (${t.errorCode})`),this.videoAnalytics.reportPlaybackError(a,Conviva.Constants.ErrorSeverity.FATAL)},this.onAdError=t=>{if(!t||!this.adAnalytics)return;this.isAdBreakStartReported||this.onAdBreakStart();let a=JSON.stringify(t);a=`${t.getMessage()} (${t.getErrorCode()})`,this.logger.log("[Conviva][AdEvent] error",t),this.adAnalytics.reportAdFailed(a,this.buildAdMetadata()),this.isAdBreakEndReported||this.onAdBreakEnd()},this.instanceOfAdComposedPlayer=t=>void 0!==t.playerContext,this.isMainContext=t=>!t||!this.instanceOfAdComposedPlayer(t)||t.playerContext===i.MAIN,this.buildAdMetadata=t=>{var a,e,i;const s={};return this.adMetadata&&(s["c3.ad.adStitcher"]=null!==(a=this.adMetadata.adStitcher)&&void 0!==a?a:"NA",s["c3.ad.mediaFileApiFramework"]=null!==(e=this.adMetadata.adMediaFileApiFramework)&&void 0!==e?e:"NA",s["c3.ad.isSlate"]=null!==(i=this.adMetadata.isSlate)&&void 0!==i?i:"false",s["c3.ad.technology"]=this.adMetadata.adTechnology&&this.adMetadata.adTechnology===d.SERVER_SIDE?Conviva.Constants.AdType.SERVER_SIDE:Conviva.Constants.AdType.CLIENT_SIDE),t&&(this.setVastProperties(s,t.vastProperties),s[Conviva.Constants.IS_LIVE]=this.metadata&&this.metadata[Conviva.Constants.IS_LIVE]?this.metadata[Conviva.Constants.IS_LIVE]:this.isLive(this.internalPlayer),s["Conviva.duration"]=t.durationMs?t.durationMs/1e3:0,s["c3.ad.id"]=t.adID,s["c3.ad.position"]=this.toC3AdPosition(t.adBreakInfo),s["c3.ad.firstAdSystem"]=this.toC3AdFirstAdSystem(t),s["c3.ad.firstAdId"]=this.toC3AdFirstAdId(t),s["c3.ad.firstCreativeId"]=this.toC3AdFirstCreavtiveId(t)),this.setAdStreamUrl(s,t),s},this.toC3AdPosition=t=>{if(!t)return Conviva.Constants.AdPosition.PREROLL;switch(t.contentTimePosition){case s.MIDROLL:return Conviva.Constants.AdPosition.MIDROLL;case s.POSTROLL:return Conviva.Constants.AdPosition.POSTROLL;case s.PREROLL:default:return Conviva.Constants.AdPosition.PREROLL}},this.isLive=t=>t?t.isLive?Conviva.Constants.StreamType.LIVE:Conviva.Constants.StreamType.VOD:Conviva.Constants.StreamType.UNKNOWN,this.isInitialized=()=>!!this.videoAnalytics,this.destroy=()=>{this.videoAnalytics&&(this.videoAnalytics.release(),this.videoAnalytics=void 0),this.adAnalytics&&(this.adAnalytics.release(),this.adAnalytics=void 0),Conviva.Analytics.release()},this.internalPlayer=void 0,this.isAdBreakStartReported=!1,this.isAdBreakEndReported=!1,this.deviceMetadata=h,this.adPlayerInfo=v,this.logger=c||r(o.OFF,"FL_CONVIVA_SESSION")}initialize(){if(this.initializationData.debug){if(!this.initializationData.gatewayUrl)return void this.logger.log("[Conviva] Gateway URL is missing. Debug session not initialized.");const t={[Conviva.Constants.GATEWAY_URL]:this.initializationData.gatewayUrl,[Conviva.Constants.LOG_LEVEL]:Conviva.Constants.LogLevel.DEBUG};Conviva.Analytics.init(this.initializationData.customerKey,null,t)}else Conviva.Analytics.init(this.initializationData.customerKey,null);Conviva.Analytics.setDeviceMetadata(this.deviceMetadata),this.videoAnalytics=Conviva.Analytics.buildVideoAnalytics(),this.adAnalytics=Conviva.Analytics.buildAdAnalytics(this.videoAnalytics),this.adAnalytics.setAdPlayerInfo(this.adPlayerInfo?this.adPlayerInfo:{}),this.logger.log("[Conviva] Session initialized",this.initializationData)}reportPlaybackRequested(t,a){this.isInitialized()&&this.videoAnalytics?(this.metadata=t,this.adMetadata=a,this.videoAnalytics.reportPlaybackRequested(this.metadata)):this.logger.log("[Conviva][Error] Session is not initialized")}attachPlayer(t){this.isInitialized()&&this.videoAnalytics?(this.internalPlayer=t,this.subscribeToInternalPlayerEvents(this.internalPlayer),this.logger.log("[Conviva] Player attached")):this.logger.log("[Conviva][Error] Session is not initialized")}setContentMetadata(t){this.videoAnalytics&&this.videoAnalytics.setContentInfo(t)}reportError(t){this.onError(t)}reportEvent(t,a){this.reportCustomEvent(t,a)}reportPlaybackMetricEvent(t,a,e){this.videoAnalytics&&this.reportPlaybackMetric(t,a,e)}reportPlaybackMetric(t,a,e){this.videoAnalytics&&this.videoAnalytics.reportPlaybackMetric(t,a,e)}reportCustomEvent(t,a){this.videoAnalytics&&this.videoAnalytics.reportPlaybackEvent(t,a)}reportAppBackgrounded(){Conviva.Analytics.reportAppBackgrounded()}reportAppForegrounded(){Conviva.Analytics.reportAppForegrounded()}setVastProperties(t,a){var e,i,s;a&&(t[Conviva.Constants.ASSET_NAME]=null!==(e=a.adTitle)&&void 0!==e?e:"ad name",t["c3.ad.system"]=null!==(i=a.adSystem)&&void 0!==i?i:"NA",t["c3.ad.creativeId"]=null!==(s=a.creativeId)&&void 0!==s?s:"NA")}setAdStreamUrl(t,a){a&&a.mediaUrl?t[Conviva.Constants.STREAM_URL]=a.mediaUrl:this.adMetadata&&this.adMetadata.adMediaUrl&&(t[Conviva.Constants.STREAM_URL]=this.adMetadata.adMediaUrl)}toC3AdFirstAdSystem(t){return t.vastProperties&&t.vastProperties.adSystem&&1===t.sequence?t.vastProperties.adSystem:"NA"}toC3AdFirstCreavtiveId(t){return t.vastProperties&&t.vastProperties.creativeId&&1===t.sequence?t.vastProperties.creativeId:"NA"}toC3AdFirstAdId(t){return 1===t.sequence?t.adID:"NA"}}function h(t,a,e,i){return new l(t,a,e,i)}const v="7.0.56";export{d as AdTechnology,h as createConvivaSession,v as version};

