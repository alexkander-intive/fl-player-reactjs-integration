/*! ******************************************************************************* 
   Package Name: fl-platform-authorizer
   Generated: 2022-08-24
   Version: 7.0.56

   Copyright (C) Firstlight Media. All rights reserved.  
   
   All information contained herein is, and remains the property of Firstlight Media. 
   The intellectual and technical concepts contained herein are proprietary to 
   Firstlight Media.  

   Dissemination of this information or reproduction of this material is strictly 
   forbidden unless prior written permission is obtained from Firstlight Media.  
   ******************************************************************************* */
import{createLogger as e,createRequestBuilder as t,createHttpClient as r,createError as n,isError as o,ErrorCodes as i,createKeyValueStore as s,PlatformUtil as c}from"fl-foundation";import{Resolution as a}from"fl-player-interface";var u;!function(e){e.PARAM_KEY_CLIENT_ID="client_id",e.PARAM_KEY_CLIENT_SECRET="client_secret",e.PARM_KEY_GRANT_TYPE="grant_type",e.PARAM_KEY_AUDIENCE="audience",e.PARAM_KEY_SCOPE="scope",e.PARAM_VALUE_GRANT_TYPE_CLIENT_CREDENTIALS="client_credentials",e.PARAM_VALUE_AUDIENCE="edge-service",e.PARAM_VALUE_SCOPE="offline openid"}(u||(u={}));const E="access_token",d="expires_in",R="token_type",_="scope",A="error",p="error_description",f=Object.freeze({PLATFORM_SERVICE_ACCESS_TOKEN_FAILURE:257,PLATFORM_SERVICE_INVALID_ACCESS_TOKEN:258,PLATFORM_SERVICE_USER_ACCESS_TOKEN_FAILURE:259,PLATFORM_SERVICE_CALL_INTERRUPTED:260,PLATFORM_SERVICE_MALFORMED_RESPONSE:261,PLATFORM_SERVICE_ERROR:262});function S(s){const c=e();return{authorize:async function(e,a){try{const o=await async function(e,n){const o={[u.PARAM_KEY_CLIENT_ID]:e,[u.PARAM_KEY_CLIENT_SECRET]:n,[u.PARM_KEY_GRANT_TYPE]:u.PARAM_VALUE_GRANT_TYPE_CLIENT_CREDENTIALS,[u.PARAM_KEY_AUDIENCE]:u.PARAM_VALUE_AUDIENCE,[u.PARAM_KEY_SCOPE]:u.PARAM_VALUE_SCOPE},i=function(e){return t().url(s).headers({"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"}).post(e).build()}(Object.entries(o).map((([e,t])=>encodeURIComponent(e)+"="+encodeURIComponent(t))).join("&"));return r().callWith(i)}(e,a);return function(e){switch(e.isSuccessful){case!0:return function(e){if(!e)throw n(f.PLATFORM_SERVICE_MALFORMED_RESPONSE|i.ERROR_CATEGORY_MASK_SERVER,"Invalid server response");const t={accessToken:e[E],tokenExpiresInSeconds:e[d],tokenType:e[R],error:e[A],errorDescription:e[p]};if(!t.accessToken){const e={errorCode:t.error,errorMessage:`Server error message: ${t.errorDescription}`};throw n(f.PLATFORM_SERVICE_MALFORMED_RESPONSE|i.ERROR_CATEGORY_MASK_SERVER,"Invalid server response",void 0,JSON.stringify(e))}return{accessToken:e[E],tokenType:e[R],scope:e[_],tokenExpiresInSeconds:e[d],createdTime:Math.round(Date.now()/1e3)}}(e.body);case!1:throw n(f.PLATFORM_SERVICE_ACCESS_TOKEN_FAILURE,"AccessToken fetch failed")}}(o)}catch(e){return function(e){if(c.error("Authorization error",e),o(e))return Promise.reject(e);return Promise.reject(n(f.PLATFORM_SERVICE_ERROR,"AccessToken fetch failed"))}(e)}}}}let l;function h(t,r){if(l)return l;let n;const i=e();i.log("Starting the Platform service ");const c=S(t.authorizationEndPoint),a=s("PLATFORM_AUTHORIZER",sessionStorage);function u(e){return R(),clearInterval(n),Promise.reject(e)}async function E(){try{const e=await c.authorize(t.clientID,t.clientSecret);return o(e)?(i.debug(`Authorization request has failed ${e}`),u(e)):(function(e){try{r=e,a.set("PLATFORM_SERVICE_STORE_ACCESS_TOKEN",r),t=1e3*e.tokenExpiresInSeconds-15e3,n=setTimeout((async()=>{try{clearInterval(n);const e=d();if(!e)throw e;return E()}catch(e){throw i.debug(`Refresh Authorization request has failed ${Error}`),u(e)}}),t)}catch(e){throw u(e)}var t;var r}(e),Promise.resolve(e))}catch(e){return i.debug(`Authorization request has failed ${e}`),u(e)}}function d(){return a.get("PLATFORM_SERVICE_STORE_ACCESS_TOKEN")}function R(){a.remove("PLATFORM_SERVICE_STORE_ACCESS_TOKEN")}return l={get platformConfig(){return t},get oAuthService(){return c},get userAuthorizationDelegate(){return r},dispose(){i.log("Stopping the Platform service "),R(),clearInterval(n),l=void 0},ensureAuthorization:()=>async function(){const e=d();if(!e||!function(e){const t=Math.round(Date.now()/1e3)-e.createdTime,r=e.tokenExpiresInSeconds-t,n=.05*e.tokenExpiresInSeconds;if(r<=n)return i.debug("Authorization token has expired"),!1;return!0}(e))return E();return e}()},l}async function T(e,t,r){try{const[n,i]=await Promise.all([t.ensureAuthorization(),t.userAuthorizationDelegate.fetchUserAuthorizationToken()]);if(o(n))return Promise.reject(n);if(o(i))return Promise.reject(i);const s=i,c={Authorization:`Bearer ${n.accessToken}`,"X-Client-Id":t.platformConfig.xClientId,"X-Authorization":s.accessToken};return Object.assign(r.headers,c),e.callWith(r)}catch(e){return Promise.reject(function(e,t){return t.code&&401===t.code?(e.dispose(),n(f.PLATFORM_SERVICE_INVALID_ACCESS_TOKEN|i.ERROR_CATEGORY_MASK_SERVER,"Unauthorized access",t)):n(f.PLATFORM_SERVICE_CALL_INTERRUPTED|i.ERROR_CATEGORY_MASK_NETWORK,"Network error has occured",t)}(t,e))}}let m=-1,C=-1;const P={async makeAuthorizedRequest(e,t){try{const c=r(),a=await T(c,t,e);if(!a||!a.body)return Promise.reject(n(f.PLATFORM_SERVICE_MALFORMED_RESPONSE|i.ERROR_CATEGORY_MASK_SERVER,"Invalid server response"));const u=a.body;return u.header&&u.header.system_time&&(s=u.header.system_time,m=s,-1!==m&&(C=(new Date).getTime())),(o=u.header)&&0!==parseInt(o.code.toString())?Promise.reject(function(e){const t=parseInt(e.errors[0].code),r=e.errors[0].description;let o="";e.errors.forEach((e=>{o+=e.code+" ",o+=e.description+" "})),o=r.trim();const s=n(t,r,void 0,o);return n(f.PLATFORM_SERVICE_ERROR|i.ERROR_CATEGORY_MASK_SERVER,r,s)}(u.header)):Promise.resolve(u)}catch(e){return Promise.reject(e)}var o,s},platformServiceTime:()=>-1===m?m:m+((new Date).getTime()-C)};var O,g=new Uint8Array(16);function I(){if(!O&&!(O="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return O(g)}var v=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function M(e){return"string"==typeof e&&v.test(e)}for(var y=[],L=0;L<256;++L)y.push((L+256).toString(16).substr(1));function N(e,t,r){var n=(e=e||{}).random||(e.rng||I)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){r=r||0;for(var o=0;o<16;++o)t[r+o]=n[o];return t}return function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=(y[e[t+0]]+y[e[t+1]]+y[e[t+2]]+y[e[t+3]]+"-"+y[e[t+4]]+y[e[t+5]]+"-"+y[e[t+6]]+y[e[t+7]]+"-"+y[e[t+8]]+y[e[t+9]]+"-"+y[e[t+10]]+y[e[t+11]]+y[e[t+12]]+y[e[t+13]]+y[e[t+14]]+y[e[t+15]]).toLowerCase();if(!M(r))throw TypeError("Stringified UUID is invalid");return r}(n)}const V=(e,t)=>{let r,n,o;let i;let s;let u,E;c.isTizen()?(i=navigator.userAgent,"undefined"!=typeof tizen&&(r=tizen.systeminfo.getCapability("http://tizen.org/system/manufacturer")),"undefined"!=typeof webapis&&(n=webapis.productinfo.getModel(),o=webapis.productinfo.getRealModel(),webapis.productinfo.isUdPanelSupported()?s=a["4K"]:webapis.productinfo.is8KPanelSupported()&&(s=a["8K"]))):c.isWebOS()&&(i=navigator.userAgent,r="LG Electronics Inc","undefined"!=typeof webOS&&webOS.deviceInfo((e=>{n=e.modelName,e.uhd8K?s=a["8K"]:e.uhd?s=a["4K"]:e.screenWidth>1920&&e.screenHeight>1080?s=a["2K"]:1920===e.screenWidth&&1080===e.screenHeight?s=a.FHD:1280===e.screenWidth&&720===e.screenHeight&&(s=a.HD)}))),u=d("audio",{ac3:"ac-3",eac3:"ec-3",mhm1:"mhm1.0x0D",mp4a:"mp4a.40.2"}),E=d("video",{avc:"avc1.64001E",hevc:"hev1.1.6.L93.90",vp8:"vp8",vp9:"vp9",av01:"av01.0.01M.08"});function d(e,t){const r=[];return"undefined"!=typeof MediaSource&&Object.keys(t).forEach((n=>{MediaSource.isTypeSupported(`${e}/mp4; codecs="${t[n]}"`)&&r.push(n)})),r.length>0?r.join(","):void 0}return{get id(){return e||N()},get name(){return t||(c.isTizen()?"samsungtizentv":c.isWebOS()?"lgwebostv":c.isPS4()?"ps4":c.isPS5()?"ps5":c.isXbox()?"xbox":c.isWPE()?"x1":c.isChromecast()?"castclient":c.isVizio()?"viziotv":"web")},get deviceManufacturer(){return r},get deviceModelName(){return n},get deviceModelNumber(){return o},get deviceYear(){},get deviceOs(){return i},get deviceOsVersion(){},get supportedResolution(){return s},get supportedAudio(){},get supportedVideoCodecs(){return E},get supportedAudioCodecs(){return u}}},b={getAdobePrimetimeToken:(e,r,n,o)=>async function(e,r,n,o){const i=t().url(e).path("/platform/access/token").post({deviceId:r,deviceInfo:n}).build();try{return(await P.makeAuthorizedRequest(i,o)).data.token}catch(e){return Promise.reject(e)}}(e,r,n,o),getGeoLocation:(e,r,n)=>async function(e,r,n={}){const o=t().url(e).path("/device/location/lookup").queryParameters(n).get().build();try{return(await P.makeAuthorizedRequest(o,r)).data}catch(e){return Promise.reject(e)}}(e,r,n)};const w="7.0.56";export{P as AuthorizationUtil,f as PlatformErrorCodes,b as PlatformExtensions,h as createPlatformAuthorizer,V as createPlatformClient,T as makeAuthorizedHttpCall,w as version};

