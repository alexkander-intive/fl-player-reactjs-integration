/*! ******************************************************************************* 
   Package Name: fl-cast-platform-player
   Generated: 2022-08-24
   Version: 7.0.56

   Copyright (C) Firstlight Media. All rights reserved.  
   
   All information contained herein is, and remains the property of Firstlight Media. 
   The intellectual and technical concepts contained herein are proprietary to 
   Firstlight Media.  

   Dissemination of this information or reproduction of this material is strictly 
   forbidden unless prior written permission is obtained from Firstlight Media.  
   ******************************************************************************* */
import{createEventEmitter as e,isError as t,createLogger as a,LoggerLevel as n}from"fl-foundation";import{createPlaybackSessionBookmarker as r}from"fl-bookmarks";import{createPlatformClient as s,createPlatformAuthorizer as o}from"fl-platform-authorizer";import{createContentAuthorizer as i,AdTechnology as E,ConsumptionType as c,PlaybackMode as T}from"fl-content-authorization";import{AdContentTimePosition as d,DrmScheme as A,MediaType as u}from"fl-player-interface";import{createStreamConcurrencyResolver as l}from"fl-stream-concurrency";import{createHeartbeatBuilder as C}from"fl-heartbeat";import{YospaceAdsSessionFactory as R,YospaceAdsPlayerFactory as m,PlaybackMode as S}from"fl-ads-yospace";var _,g,N,f;!function(e){e.SENDER="sender",e.RECEIVER="receiver"}(_||(_={})),function(e){e.ERROR="error",e.INFO="info",e.SUCCESS="success"}(g||(g={})),function(e){e.USER_CONTEXT="userContext",e.PLAYBACK_AUTHORISATION="playbackAuthorisation",e.DEVICE_REGISTRATION="deviceRegistration",e.AD_BREAK_START="adBreakStart",e.AD_BREAK_END="adBreakEnd",e.AD_PROGRESS_UPDATE="adProgressUpdate",e.AD_START="adStart",e.AD_END="adEnd",e.AD_CUE_POINTS="adCuePoints",e.AD_BREAKS="adBreaks",e.STREAM_TIMELINE_EVENT="streamTimelineEvent",e.AVAILABLE_TRACKS="availableTracks",e.CUSTOM="custom",e.ACTIVE_TRACKS="activeTracks",e.SELECT_TRACK="selectTrack"}(N||(N={})),function(e){e.ERROR="ERROR",e.LOAD_MEDIA_REQUEST="LOAD_MEDIA_REQUEST",e.DEVICE_REGISTRATION_SUCCESS="DEVICE_REGISTRATION_SUCCESS",e.MEDIA_PLAYBACK_INFO_HANDLER="MEDIA_PLAYBACK_INFO_HANDLER",e.STREAM_TIMELINE_EVENT="STREAM_TIMELINE_EVENT",e.PRE_CONTENT_AUTH_REQUEST_HANDLER="PRE_CONTENT_AUTH_REQUEST_HANDLER",e.POST_CONTENT_AUTH_RESPONSE_HANDLER="POST_CONTENT_AUTH_RESPONSE_HANDLER"}(f||(f={}));const I=Object.freeze({CONTENT_TYPE_DASH:"application/dash+xml",CONTENT_TYPE_HLS:"application/x-mpegurl",CONTENT_TYPE_SS:"application/vnd.ms-sstr+xml",CONTENT_TYPE_MP4:"video/mp4",CAST_PLATFORM_CHANNEL:"urn:x-cast:com.quickplay.platform.player.cast",HTTP_HEADER_AUTHORIZATION_KEY:"Authorization",HTTP_HEADER_BEARER_AUTH_PREFIX:"Bearer"});function p(e){if(e)switch(e){case 0:return d.PREROLL;case-1:return d.POSTROLL;default:return d.MIDROLL}return d.UNKNOWN}function O(e){return{adTitle:e.title}}function L(a){let n,d,L,P,k,y,b,v,M;const D=a.configuredLogger,h=a.castPlayer,H=a.yospaceAds,U=e(),F=h.rawLibrary,V=h.rawPlayer,B=new F.framework.CastReceiverOptions,w=V.getPlayerManager(),Y=a.eventListenerCallback,K={fetchUserAuthorizationToken:()=>Promise.resolve(L)};B.customNamespaces={},B.customNamespaces[I.CAST_PLATFORM_CHANNEL]=F.framework.system.MessageType.JSON;V.addCustomMessageListener(I.CAST_PLATFORM_CHANNEL,(async e=>{if(e.data){D.debug("Message received",e.data);try{const r=e.data;if(r.messageType==g.INFO&&r.messageName==N.USER_CONTEXT){P=r.message,d&&d.invalidateDeviceToken(),n&&n.dispose(),d=void 0,t=P.userAuthToken,L={accessToken:t},n||(n=o(a.platformConfig,K)),d=function(e){d||(d=i(a.contentAuthConfiguration,n,s(e.platformClient.id),e.proxyPlatformClient));return d}(P);try{await d.registerDevice(),D.log("Device Registered");const e=J(N.DEVICE_REGISTRATION,g.SUCCESS,_.RECEIVER,"Device registered successfully");Y&&Y(f.DEVICE_REGISTRATION_SUCCESS),V.sendCustomMessage(I.CAST_PLATFORM_CHANNEL,void 0,e)}catch(e){D.error("Device Registration has failed",e);const t=J(N.DEVICE_REGISTRATION,g.ERROR,_.RECEIVER,e);Y&&Y(f.ERROR,e),V.sendCustomMessage(I.CAST_PLATFORM_CHANNEL,void 0,t)}}else{const e=J(N.CUSTOM,g.INFO,_.RECEIVER,"User context is invalid");V.sendCustomMessage(I.CAST_PLATFORM_CHANNEL,void 0,e)}}catch(e){D.error("Token Failure",e);const t=J(N.DEVICE_REGISTRATION,g.ERROR,_.RECEIVER,e);Y&&Y(f.ERROR,e),V.sendCustomMessage(I.CAST_PLATFORM_CHANNEL,void 0,t)}const r=e.data;if(r.messageType==g.INFO&&r.messageName==N.SELECT_TRACK){!function(e){const t=w.getAudioTracksManager(),a=w.getTextTracksManager();if(e)if("audio"===e.type)""===e.language?t.setActiveByIds([]):(t.setActiveByLanguage(e.language),x()),D.log("Audio Track Selected successfully");else""===e.language?a.setActiveByIds([]):(a.setActiveByLanguage(e.language),x()),D.log("Text Track Selected successfully")}(r.message)}}var t}));function x(){let e=w.getTextTracksManager().getActiveTracks(),t=w.getAudioTracksManager().getActiveTrack();e=e||[],t=t||[];const a=[];z(e,a),z(t,a),D.log("activeTracks",a);const n=J(N.ACTIVE_TRACKS,g.INFO,_.RECEIVER,a);V.sendCustomMessage(I.CAST_PLATFORM_CHANNEL,void 0,n)}function z(e,t){e.length&&e.forEach((e=>{e.type&&"text"===e.type.toLowerCase()&&t.push({language:e.language,type:"subtitle"}),t.push({language:e.language,type:e.type.toLowerCase()})}))}function G(e){const t=J(N.AD_BREAK_START,g.INFO,_.RECEIVER,e);V.sendCustomMessage(I.CAST_PLATFORM_CHANNEL,void 0,t),D.log("[ADS] adbreakstart",e)}function q(e){const t=J(N.AD_START,g.INFO,_.RECEIVER,e);V.sendCustomMessage(I.CAST_PLATFORM_CHANNEL,void 0,t),D.log("[ADS] adstart",e)}function Q(e){const t=J(N.AD_END,g.INFO,_.RECEIVER,e);V.sendCustomMessage(I.CAST_PLATFORM_CHANNEL,void 0,t),D.log("[ADS] adend",e)}function $(e){const t=J(N.AD_BREAK_END,g.INFO,_.RECEIVER,e);V.sendCustomMessage(I.CAST_PLATFORM_CHANNEL,void 0,t),D.log("[ADS] adbreakend",e)}function j(e,t){const a=J(N.AD_PROGRESS_UPDATE,g.INFO,_.RECEIVER,{adInfo:e,progress:t});V.sendCustomMessage(I.CAST_PLATFORM_CHANNEL,void 0,a),D.log("[ADS] adprogress",e,t)}function X(e){const t=J(N.AD_CUE_POINTS,g.INFO,_.RECEIVER,e);V.sendCustomMessage(I.CAST_PLATFORM_CHANNEL,void 0,t),D.log("[ADS] adcuepoints",e)}function W(e){const t=J(N.AD_BREAKS,g.INFO,_.RECEIVER,e);V.sendCustomMessage(I.CAST_PLATFORM_CHANNEL,void 0,t),D.log("[ADS] adbreaks",e)}function Z(e,t,a){const n={eventName:e,action:t,metadata:a},r=J(N.STREAM_TIMELINE_EVENT,g.INFO,_.RECEIVER,{eventName:e,action:t,metadata:a,payload:n});V.sendCustomMessage(I.CAST_PLATFORM_CHANNEL,void 0,r),Y(f.STREAM_TIMELINE_EVENT,n),D.log(`streamTimelineEvent: ${e} Action: ${t} metadata: ${a}`)}function J(e,t,a,n){return{messageName:e,messageType:t,messageOrigin:a,message:n}}function ee(e){if(e.consumptionType===c.VOD)return S.Vod;switch(e.playbackMode){case T.CATCHUP:return S.LiveCatchup;case T.RESTART:return S.LiveRestart;case T.LIVE:return S.Live}}function te(e){U.publish("castReceiverReady",e),D.log("Cast is ready to play the content")}w.setMessageInterceptor(F.framework.messages.MessageType.LOAD,(e=>new Promise((async(s,o)=>{if(e.media&&e.media.customData.castAsset){const S=e.media.customData.castAsset;Y&&(Y(f.LOAD_MEDIA_REQUEST,e),Y(f.PRE_CONTENT_AUTH_REQUEST_HANDLER,S.platformAsset)),a.isBookmarkEnabled&&(i=S.platformAsset.mediaID,y&&(y=null),y=r(i,a.bookmarkConfiguration,n),y.subscribe("thresholdlimitreached",(()=>{D.log("Threshold Limit is Reached")})),h.addStateChangeStep((e=>y&&y.processPlayerStateChange(e)))),a.isStreamConcurrencyEnabled&&(e=>{b&&(b=null),b=l(e,a.streamConcurrencyConfiguration,n),h.addStateChangeStep((e=>b&&b.processPlayerStateChange(e)))})(S.platformAsset.mediaID);try{await async function(e,r){const s=await async function(e){if(!d)return D.error("Platform is not initialized"),Promise.reject();L.accessToken=e.userAuthToken;const n=d.authorizePlayback({...e.platformAsset,...a.shouldDisableSSAI&&{disableSsai:!0}},e.headers);if(t(n)){D.error("Content Auth has failed",n);const e=J(N.PLAYBACK_AUTHORISATION,g.ERROR,_.RECEIVER,n);return V.sendCustomMessage(I.CAST_PLATFORM_CHANNEL,void 0,e),Promise.reject(n)}return Promise.resolve(n)}(e.media.customData.castAsset);Y&&Y(f.POST_CONTENT_AUTH_RESPONSE_HANDLER,s);e.media.contentUrl=await async function(e,t){return e.ssaiEnabled&&H?async function(e,t){const a=R.createYospaceAdsSession(H,D),n=await a.initialize({contentURL:e,playbackMode:ee(t),timeout:15e3});return function(e){e.subscribe("adbreakstart",G),e.subscribe("adbreakend",$),e.subscribe("adprogressupdate",j),e.subscribe("adstart",q),e.subscribe("adend",Q),e.subscribe("adcuepoints",X),e.subscribe("adbreaks",W)}(m.createYospaceAdsPlayer(h,a,H,D)),n}(e.contentUrl,t):e.contentUrl}(s,r.platformAsset),D.log("---contentUrl----",e.media.contentUrl),s.adType===E.CSAI&&s.csaiAdCuePointVmap&&(e.media.vmapAdsRequest={adTagUrl:s.csaiAdCuePointVmap});a.isHeartbeatEnabled&&s.heartbeatFlag&&((e,t,r,s)=>{k&&(k=null),k=C(t,e,{...a.heartbeatConfiguration,syncIntervalMS:r.heartbeatFreq},n).setHeartbeatToken(r.heartbeatToken).setLiveEndTime(r.liveEndTime).setLiveStartTime(r.liveStartTime).setLiveEventType(r.liveEventType).setHeaders(s.headers).setLogger(D).build(),h.addStateChangeStep((()=>k&&k.processPlayerStateChange(h))),h.addHeartBeatStep((()=>k&&k.processHeartbeatChange(h)))})(r.platformAsset.mediaID,P.platformClient.id,s,r);let o=r.platformAsset.consumptionType;o===c.LIVE&&r.platformAsset.playbackMode===T.CATCHUP&&(o=c.VOD);(function(e,a,r){w.setMediaPlaybackInfoHandler((s=>(Y(f.MEDIA_PLAYBACK_INFO_HANDLER,s),function(e,t){switch(e){case c.VOD:t.media.streamType="BUFFERED";break;case c.LIVE:t.media.streamType="LIVE";break;default:t.media.streamType="NONE"}}(r,a),function(e,t){switch(e){case u.DASH:t.media.contentType=I.CONTENT_TYPE_DASH;break;case u.HLS:t.media.contentType=I.CONTENT_TYPE_HLS;break;case u.MP4:t.media.contentType=I.CONTENT_TYPE_MP4;break;case u.SMOOTH_STREAMING:t.media.contentType=I.CONTENT_TYPE_SS;break;default:t.media.contentType=I.CONTENT_TYPE_DASH}}(e.mediaType,a),function(e,t){switch(e){case A.WIDEVINE:t.protectionSystem=F.framework.ContentProtection.WIDEVINE;break;case A.PLAYREADY:t.protectionSystem=F.framework.ContentProtection.PLAYREADY;break;case A.CLEARKEY:t.protectionSystem=F.framework.ContentProtection.CLEARKEY;break;default:t.protectionSystem=F.framework.ContentProtection.NONE}}(e.drmScheme,s),s.licenseRequestHandler=async e=>{try{const a=await n.ensureAuthorization();if(!t(a)){const t={[I.HTTP_HEADER_AUTHORIZATION_KEY]:`${I.HTTP_HEADER_BEARER_AUTH_PREFIX} ${a.accessToken}`};Object.assign(e.headers,t)}}catch(e){D.log("ensureAuthorization is failed",e)}},s.licenseUrl=e.drmLicenseUrl,s)))})(s,e,o),function(){const e=J(N.PLAYBACK_AUTHORISATION,g.SUCCESS,_.RECEIVER,"Playback is authorised successfully");V.sendCustomMessage(I.CAST_PLATFORM_CHANNEL,void 0,e)}()}(e,S),s(e)}catch(e){!function(e){D.error("Content Auth failed",e);const t=J(N.PLAYBACK_AUTHORISATION,g.ERROR,_.RECEIVER,e);Y&&Y(f.ERROR,e);V.sendCustomMessage(I.CAST_PLATFORM_CHANNEL,void 0,t)}(e),o(e)}}var i}))));return h.subscribe("castReceiverReady",te),h.subscribe("streamtimelineevent",Z),h.addHeartBeatStep((()=>{})),h.addStateChangeStep((()=>{D.log("stateChanged value")})),null!=F.framework.events&&(w.addEventListener(F.framework.events.EventType.PLAYING,(e=>{D.log("PLAYING_EVENT",e),function(){const e=w.getTextTracksManager().getTracks(),t=w.getAudioTracksManager().getTracks(),a=[];z(e,a),z(t,a),D.log("availableTracks",a);const n=J(N.AVAILABLE_TRACKS,g.INFO,_.RECEIVER,a);V.sendCustomMessage(I.CAST_PLATFORM_CHANNEL,void 0,n)}(),x()})),w.addEventListener(F.framework.events.EventType.BREAK_STARTED,(e=>{M=function(e,t){const a=e.getBreakManager().getBreakById(t.breakId);return{adBreakID:t.breakId||" ",contentTimePosition:p(a.position),adSequencePosition:1,adBreakStartTimeOffsetMs:1e3*t.currentMediaTime,remainingTimeMs:-1e3,durationMs:1e3*a.duration||-1e3,totalAds:t.total,adBreakIndex:a.position}}(w,e),G(M)})),w.addEventListener(F.framework.events.EventType.BREAK_ENDED,(e=>{$(M),M=void 0})),w.addEventListener(F.framework.events.EventType.BREAK_CLIP_STARTED,(e=>{v=function(e,t,a){const n=e.getBreakManager().getBreakClipById(t.breakClipId);return{adID:t.breakClipId||" ",sequence:t.index,adStartTimeOffsetMs:1e3*t.currentMediaTime,durationMs:1e3*n.duration,isSkippable:!!(t.whenSkippable&&t.whenSkippable>=0),skipOffsetMs:1e3*t.whenSkippable,isFiller:!1,adBreakInfo:a||void 0,vastProperties:n?O(n):void 0}}(w,e,M),q(v)})),w.addEventListener(F.framework.events.EventType.BREAK_CLIP_ENDED,(e=>{Q(v),v=void 0}))),h.load(),h}function P(){let e,t,r,s,o,i,E,c,T,d=a(n.OFF,"FL_CAST_PLATFORM_PLAYER"),A=!1,u=!1,l=!1,C=!1;return{get streamConcurrencyConfiguration(){if(e)return e;throw"Stream Concurrency Configuration is missing"},get bookmarkConfiguration(){if(t)return t;throw"Bookmark Configuration is missing"},get heartbeatConfiguration(){if(r)return r;throw"Heartbeat Configuration is missing"},get contentAuthConfiguration(){if(s)return s;throw"Content Authorization Configuration is missing"},get configuredLogger(){return d},get isBookmarkEnabled(){return A},get isStreamConcurrencyEnabled(){return u},get isHeartbeatEnabled(){return l},get shouldDisableSSAI(){return C},get serverCertificate(){return o},get castPlayer(){return E},get yospaceAds(){return i},get platformConfig(){return c},get eventListenerCallback(){return T},addCastPlayer(e){return E=e,this},addApplicationConfig(a){return e={endPointUrl:a.streamConcurrencyEndPoint,syncIntervalMS:a.streamConcurrencySyncIntervalMS},t={endPointUrl:a.bookmarkEndPoint,syncIntervalMS:a.bookmarkSyncIntervalMS,thresholdPercentage:a.bookmarkThresholdPercentage},r={heartbeatEndPointUrl:a.heartbeatEndPoint,streamConcurrencyEndPointUrl:a.streamConcurrencyEndPoint,syncIntervalMS:a.heartbeatSyncIntervalMS,multiStreamMode:a.multiStreamMode,stopPlayerOnStreamTimelineEvent:a.stopPlayerOnStreamTimelineEvent},s={endPointUrl:a.playbackAuthEndPoint,clientRegistrationEndPointUrl:a.clientRegistrationEndPoint},c={clientID:a.clientID,clientSecret:a.clientSecret,xClientId:a.xClientId,authorizationEndPoint:a.authorizationEndPoint},l=a.enableHeartbeat||!1,C=a.disableSSAI||!1,this},addCertificate(e){return o=e,this},addYospaceAds(e){return i=e,this},enableStreamConcurrency(){return u=!0,this},enableBookmark(){return A=!0,this},disableSSAI(){return C=!0,this},logger(e){return d=e,this},castEventListener(e){return T=e,this},build(){return L(this)}}}const k="7.0.56";export{f as CastEventMessage,L as createCastPlatformPlayer,P as createCastPlatformPlayerBuilder,k as version};

